name: ðŸ”„ Master Timed Scraper Batch 

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for dispatching the orchestrator'
        required: false
        default: 'Timed sequential run'

# Permissions are essential for dispatching other workflows
permissions:
  actions: write 
  contents: read

jobs:
  trigger_workflows:
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      # --- STEP 1: Simultaneously Trigger Batch 1 and Batch 2 ---
      - name: ðŸš€ Trigger Batch 1 and Batch 2
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const dispatch = async (workflowFile) => {
              console.log(`Dispatching workflow: ${workflowFile}`);
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: workflowFile,
                ref: context.ref,
                inputs: {} // Add inputs if your child workflows require them
              });
              console.log(`Successfully dispatched ${workflowFile}`);
            };

            // Trigger scraper_batch1.yml
            dispatch('scraper_batch1.yml'); 
            
            // Trigger scraper_batch2.yml (Note: No 'await' for the first dispatch ensures they start nearly simultaneously)
            dispatch('scraper_batch2.yml'); 


      # -----------------------------------------------------------------
      # --- STEP 2: Wait 10 Minutes ---
      - name: â³ Wait for 10 minutes (Before Batch 3)
        uses: actions/github-script@v6
        with:
          script: |
            // Delay for 10 minutes (10 * 60 * 1000 milliseconds)
            const delay = 10 * 60 * 1000; 
            console.log(`Waiting for ${delay / 1000 / 60} minutes...`);
            await new Promise(resolve => setTimeout(resolve, delay));
            console.log('Wait complete, proceeding to Batch 3.');


      # -----------------------------------------------------------------
      # --- STEP 3: Trigger Batch 3 ---
      - name: ðŸš€ Trigger Batch 3
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Trigger scraper_batch3.yml
            const workflowFile = 'scraper_batch3.yml';
            console.log(`Dispatching workflow: ${workflowFile}`);
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflowFile,
              ref: context.ref,
              inputs: {} 
            });
            console.log(`Successfully dispatched ${workflowFile}`);


      # -----------------------------------------------------------------
      # --- STEP 4: Wait 5 Minutes ---
      - name: â³ Wait for 5 minutes (Before Batch 4)
        uses: actions/github-script@v6
        with:
          script: |
            // Delay for 5 minutes (5 * 60 * 1000 milliseconds)
            const delay = 5 * 60 * 1000;
            console.log(`Waiting for ${delay / 1000 / 60} minutes...`);
            await new Promise(resolve => setTimeout(resolve, delay));
            console.log('Wait complete, proceeding to Batch 4.');


      # -----------------------------------------------------------------
      # --- STEP 5: Trigger Batch 4 ---
      - name: ðŸš€ Trigger Batch 4
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Trigger scraper_batch4.yml
            const workflowFile = 'scraper_batch4.yml';
            console.log(`Dispatching workflow: ${workflowFile}`);
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflowFile,
              ref: context.ref,
              inputs: {} 
            });
            console.log(`Successfully dispatched ${workflowFile}`);
